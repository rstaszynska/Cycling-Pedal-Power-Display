<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Cycling Pedal Power Display</title>
    <link rel="stylesheet" href="index.css" />
  </head>
  <body>
    <div class="outer-container">
      <div class="content-container">
        <div class="text-container">
          <h1 id="heading"></h1>
          <h2>Cycle to generate electricity</h2>
        </div>

        <img id="back-arrow" src="images/back.png" onclick="go_back()"> 
        <button id="home-button" onclick="go_to_home()">Selection Screen</button>

        <div class="challenge-screen box-styling">
            <div class="left">
                <div>
                    <h2 id="appliance-name"></h2>
                    <p id="appliance-wattage"></p>
                </div>
                <img id="chosen-appliance-img"> 
                <button onclick="connectBicycle(1)">Connect Bike</button>
            </div>

            <div class="middle">
                <div id="progress-circle"></div>
                <div id="progress-text">
                    <p id="progress-percentage"></p>
                    <p>of power generated</p>
                </div>
            </div>
            
            <div class="right">
                <p id="timer-label">TIME REMAINING</p>
                <p id="timer"></p>
                <button id="button" onclick="pause_or_resume_timer()"> PAUSE </button>
            </div>
        </div>
       
      </div>
    </div>

    <script>
        /* =========================================================================================================
        Portions of the following code have been adapted from the following software released under the MIT license:
        Project: PedalPower https://github.com/Tankiolegend/PedalPower
        */

        var bike1pwr = 0;
        var bike2pwr = 0;

        class Bicycle {

            device;

            async connectBicycle(bicycleNumber) {
                await navigator.bluetooth.requestDevice({
                    // acceptAllDevices: true
                    filters: [{ services: ['00001818-0000-1000-8000-00805f9b34fb'] }]
                })
                    .then(device => {
                        this.device = device;
                        this.device.addEventListener('gattserverd', function () {
                            setTimeout(function () {
                                reconnectBicycle(bicycleNumber);
                            }, 2000);
                        });

                        this.startConnection(bicycleNumber);
                    })
            }

            async startConnection(bicycleNumber) {
            await this.device.gatt.connect()
                .then(reserver => {
                return reserver.getPrimaryService('00001818-0000-1000-8000-00805f9b34fb');
                }).then(service => {
                return service.getCharacteristic('00002a63-0000-1000-8000-00805f9b34fb');
                }).then(characteristic => characteristic.startNotifications())

                .then(characteristic => {
                characteristic.addEventListener('characteristicvaluechanged',
                    function () {
                        testChange(event, bicycleNumber);
                    }
                )
                ;
                beginTimer();

                }).catch(error => { console.error(error); });
            }

            async disconnectDevice() {
            await this.device.gatt.disconnect();
            }

            isConnected() {
                if (typeof (this.device) === "undefined") {
                    return false;

                } else {
                    return this.device.gatt.connected;
                }
            }
        }

        const deviceOne = new Bicycle();
        const deviceTwo = new Bicycle();

        async function connectBicycle(bicycleNumber) {
            if (bicycleNumber == 1) {
                await deviceOne.connectBicycle(bicycleNumber);
            } 
            else {
                await deviceTwo.connectBicycle(bicycleNumber);
            }
        }

        async function reconnectBicycle(bicycleNumber) {
        if (bicycleNumber == 1) {
            await deviceOne.startConnection(bicycleNumber);
            if (!deviceOne.isConnected()) {
            setTimeout(function () {
                reconnectBicycle(bicycleNumber);
            }, 5000);
            }
        } 
        else {
            deviceTwo.startConnection(bicycleNumber);
            if (!deviceTwo.isConnected()) {
            setTimeout(function () {
                reconnectBicycle(bicycleNumber);
            }, 5000);
            }
        }
        }

        async function disconnectBicycle (bicycleNumber) {
        if (bicycleNumber == 1) {
            await deviceOne.disconnectDevice();
        } else {
            await deviceTwo.disconnectDevice();
        };
        }

        function testChange(event, bicycleNumber) {
            power = event.target.value.getUint8(2, true);

            if (bicycleNumber == 1) {
                bike1pwr += power;
            } else {
                bike2pwr += power;
            };
        }
        
        // =========================================================================================================


        const params = new Proxy(new URLSearchParams(window.location.search), {
        get: (searchParams, prop) => searchParams.get(prop),
        });
        let appliance = params.appliance;
        let mode = params.mode;
        let duration = params.duration;


        if (appliance === "led" || appliance === "incandescent") {
            document.querySelector('#heading').innerHTML = "Can you power an " + appliance + " light bulb?";
        }
        else {
            document.querySelector('#heading').innerHTML = "Can you power a " + appliance + "?";
        }

        const box_styling = document.querySelector('.box-styling')
        box_styling.style.border = '10px solid #4D9FFF';
        const progress_circle = document.querySelector('#progress-circle');
        const appliance_img = document.querySelector('#chosen-appliance-img');
        appliance_img.src = "images/" + appliance + ".png";
    
        const name = document.querySelector('#appliance-name');
        const wattage = document.querySelector('#appliance-wattage');

        var background_color;
        var secondary_color;

        if (appliance === "led" || appliance === "kettle" || appliance === "laptop") {
            background_color = "#7CC0FF";
            secondary_color = "#b5dbfc";

            if (appliance === "led") {
                name.innerHTML = "LED Light Bulb";
                wattage.innerHTML = "W";
            }
            else if (appliance === "kettle") {
                name.innerHTML = "Electric Kettle";
                wattage.innerHTML = "W";
            }
            else if (appliance === "laptop") {
                name.innerHTML = "Laptop";
                name.style.marginTop = "10vh";
                wattage.innerHTML = "W";
                appliance_img.style.height = "47.5%";
                appliance_img.style.marginTop = "1vh";
            }
        }
        else {
            background_color = "#99ECF8";
            secondary_color = "#baf3fc";

            if (appliance === "incandescent") {
                name.innerHTML = "Incandescent Light Bulb";
                wattage.innerHTML = "W";
            }
            else if (appliance === "toaster") {
                name.innerHTML = "Toaster";
                name.style.marginTop = "10vh";
                wattage.innerHTML = "W";
                appliance_img.style.height = "40%";
                appliance_img.style.marginTop = "1vh";
            }
            else if (appliance === "washingmachine") {
                name.innerHTML = "Washing Machine";
                wattage.innerHTML = "W";
            }
        }

        box_styling.style.backgroundColor = background_color;
        
        angle = 0;
        progress_circle.style.background = "radial-gradient(" + background_color + " 50%, transparent 51%), conic-gradient(black 0deg " + angle + "deg, " + secondary_color + " " + (angle+1) + "deg 360deg)";
        document.querySelector('#progress-percentage').innerHTML = 0 + "%";
                        
        var timer_paused = false;

        function beginTimer() {
            if (duration === "No timer") {
                document.getElementById("timer").innerHTML = "No timer";
            }

            else {
                if (duration === "30 seconds") {
                    var time = new Date().getTime()+ 32000;
                }
                else if (duration === "1 minute") {
                    var time = new Date().getTime()+ 62000;
                }
                else if (duration === "3 minutes") {
                    var time = new Date().getTime()+ 182000;
                }
                
                var x = setInterval(function() {
                    if ( !timer_paused ) {
                        var distance = time - new Date().getTime();

                        var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        var seconds = Math.floor((distance % (1000 * 60)) / 1000);

                        if (seconds < 10) {
                            seconds = "0" + seconds;
                        }

                        if (distance > 0) {
                            document.getElementById("timer").innerHTML = minutes + ":" + seconds;
                            
                            // Goal not yet reached
                            if (bike1pwr > 0 && Math.round(bike1pwr/100) <= 100) {
                                var percentage = Math.round(bike1pwr/100);
                                angle = percentage * 0.01 * 360;
                                progress_circle.style.background = "radial-gradient(" + background_color + " 50%, transparent 51%), conic-gradient(black 0deg " + angle + "deg, " + secondary_color + " " + (angle+1) + "deg 360deg)";
                                document.querySelector('#progress-percentage').innerHTML = Math.round(percentage) + "%";
                            }

                            // Goal reached
                            else {
                                // Disconnect bicycle
                                disconnectBicycle(bicycleNumber);
                            }
                        }
                        // Time's up
                        else {
                            clearInterval(x);
                        }
                    }
                    else {
                        time += 1000;
                    }

                }, 1000);
            }
        }
        
        function pause_or_resume_timer() {
            if (!timer_paused) {
                timer_paused = true;
                document.getElementById("button").innerHTML = "RESUME";
            }
            else {
                timer_paused = false;
                document.getElementById("button").innerHTML = "PAUSE";
            }
        }

        function go_back() {     
            location.href = "timer_duration_selection.html?appliance=" + appliance + "&mode=" + mode;
        }

        function go_to_home(){
            location.href = "index.html";
        }

    </script>
  </body>
</html>
